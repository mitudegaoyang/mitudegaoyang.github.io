---
title: Lighthouse测试
tags:
  - 技术积累
  - chrome
  - html
categories:
  - 技术积累
  - chrome
  - html
toc: true
abbrlink: 6cf0f9a5
date: 2022-01-05 09:35:42
---

![首屏图](https://s4.ax1x.com/2022/01/05/TXBKnH.jpg)

<!-- more -->

## Lighthouse 简介

Lighthouse 是一个开源的自动化工具，用于改进网络应用的质量。只要为 Lighthouse 提供一个需要审查的网址，它将针对此页面运行一连串的测试，然后生成一个有关页面性能的报告。

## Lighthouse 使用方式

目前官方提供了 4 种使用方式：

- [Chrome 开发者工具（DevTools）](https://github.com/GoogleChrome/lighthouse#using-lighthouse-in-chrome-devtools)
- [Chrome 扩展](https://github.com/GoogleChrome/lighthouse#using-the-chrome-extension)
- [Node CLI](https://github.com/GoogleChrome/lighthouse#using-the-node-cli)
- [Node Module](https://github.com/GoogleChrome/lighthouse#using-the-node-module)

以 Chrome 开发者工具为例，在 Lighthouse 面板下，用户可以配置测试平台、测试类目、限速方式等，可以方便快捷地发起一次测试。

![Lighthouse](https://s4.ax1x.com/2022/01/06/TxXM7D.png)

## Lighthouse 测试报告

测试结束后，默认会生成 HTML 格式的报告，如下图所示，在报告中涵盖了 5 大类别（categories）的测试评分：

![categories](https://s4.ax1x.com/2022/01/05/TXB84P.jpg)

每个类别都包含一系列的审计项（audit），针对审计项的运行结果，Lighthouse 会给出特定的优化建议与诊断结果帮助开发者有针对性地进行优化。

### First Contentful Paint 首次内容绘制(FCP)

首次内容绘制 (FCP) 是测量感知加载速度的一个以用户为中心的重要指标，因为该项指标会在用户首次在屏幕上看到任何内容时，
在页面加载时间轴中标记出相应的点，迅捷的 FCP 有助于让用户确信某些事情正在进行。

#### 什么是 FCP

首次内容绘制 (FCP) 指标测量页面从开始加载到页面内容的任何部分在屏幕上完成渲染的时间。对于该指标，"内容"指的是文本、图像（包括背景图像）、`<svg>`元素或非白色的`<canvas>`元素。

![FCP](https://s4.ax1x.com/2022/01/05/TXBxUI.png)

在上方的加载时间轴中，FCP 发生在第二帧，因为那是首批文本和图像元素在屏幕上完成渲染的时间点。

您会注意到，虽然部分内容已完成渲染，但并非所有内容都已经完成渲染。
这是首次内容绘制 (FCP) 与*Largest Contentful Paint 最大内容绘制 (LCP)*（旨在测量页面的主要内容何时完成加载）之间的重要区别。

#### 如何改进 FCP

[常见解决方案:](https://web.dev/i18n/zh/fcp/)

- 消除阻塞渲染的资源
- 缩小 CSS
- 移除未使用的 CSS
- 预连接到所需的来源
- 减少服务器响应时间 (TTFB)
- 避免多个页面重定向
- 预加载关键请求
- 避免巨大的网络负载
- 使用高效的缓存策略服务静态资产
- 避免 DOM 过大
- 最小化关键请求深度
- 确保文本在网页字体加载期间保持可见
- 保持较低的请求数和较小的传输大小

### Time to Interactive 可交互时间(TTI)

可交互时间 (TTI) 是测量加载响应度的重要实验室指标。该指标有助于识别看起来具备交互性但实际上并非如此的页面情况。迅捷的 TTI 有助于确保页面的有效性。

#### 什么是 TTI

TTI 指标测量页面从开始加载到主要子资源完成渲染，并能够快速、可靠地响应用户输入所需的时间。

如需根据网页的性能跟踪计算 TTI，请执行以下步骤：

- 先进行 First Contentful Paint 首次内容绘制 (FCP)。
- 沿时间轴正向搜索时长至少为 5 秒的安静窗口，其中，安静窗口的定义为：没有长任务且不超过两个正在处理的网络 GET 请求。
- 沿时间轴反向搜索安静窗口之前的最后一个长任务，如果没有找到长任务，则在 FCP 步骤停止执行。
- TTI 是安静窗口之前最后一个长任务的结束时间（如果没有找到长任务，则与 FCP 值相同）。

下图将有助于您更直观地理解上述步骤：

![显示 TTI 计算方式的页面加载时间轴](https://web-dev.imgix.net/image/admin/WZM0n4aXah67lEyZugOT.svg)

长久以来，开发者为了追求更快的渲染速度而对页面进行了优化，但有时，这会以牺牲 TTI 为代价。

服务器端渲染 (SSR) 等技术可能会导致页面看似具备交互性（即，链接和按钮在屏幕上可见），
但实际上并不能进行交互，因为主线程被阻塞或是因为控制这些元素的 JavaScript 代码尚未完成加载。

当用户尝试与看似具备交互性但实际上并非如此的页面进行交互时，他们可能会有如下两种反应：

- 在最好的情况下，他们会因为页面响应缓慢而感到恼火。
- 在最坏的情况下，他们会认为页面已损坏，因此很可能直接离开。他们甚至可能对您的品牌价值丧失信心或信任。

为了避免这个问题，请尽一切努力将 FCP 和 TTI 之间的差值降至最低。如果两者在某些情况下确实存在明显差异，请通过视觉指示器清楚表明页面上的组件还无法进行交互。

#### 如何改进 TTI

[常见解决方案:](https://web.dev/i18n/zh/tti/)

- 缩小 JavaScript
- 预连接到所需的来源
- 预加载关键请求
- 减少第三方代码的影响
- 最小化关键请求深度
- 减少 JavaScript 执行时间
- 最小化主线程工作
- 保持较低的请求数和较小的传输大小

### Speed Index 速度指数

速度指数是 Lighthouse 报告的“性能”部分中跟踪的六个指标之一。每个指标都捕获页面加载速度的某些方面。

Lighthouse 以秒为单位显示速度指数：

![Speed Index](https://s4.ax1x.com/2022/01/06/TzSAQs.png)

#### 什么是速度指数

速度指数衡量页面加载期间内容的视觉显示速度。 Lighthouse 首先捕获浏览器中页面加载的视频，并计算帧之间的视觉进展。
Lighthouse 然后使用 Speedline Node.js 模块生成速度指数分数。

#### 如何改进速度指数

[常见解决方案:](https://web.dev/speed-index/)

- 最小化主线程工作
- 减少 JavaScript 执行时间
- 确保文本在字体文件加载期间保持可见

### Total Blocking Time 总阻塞时间(TBT)

总阻塞时间 (TBT) 是测量加载响应度的重要实验室指标，因为该项指标有助于量化在页面交互性变为可靠前，不可交互程度的严重性，较低的 TBT 有助于确保页面的可用性。

#### 什么是 TBT

总阻塞时间 (TBT) 指标测量 First Contentful Paint 首次内容绘制 (FCP)与 Time to Interactive 可交互时间 (TTI)之间的总时间，
这期间，主线程被阻塞的时间过长，无法作出输入响应。

每当出现长任务（在主线程上运行超过 50 毫秒的任务）时，主线程都被视作"阻塞状态"。我们说主线程处于"阻塞状态"是因为浏览器无法中断正在进行的任务。
因此，如果用户在某个长任务运行期间与页面进行交互，那么浏览器必须等到任务完成后才能作出响应。

如果任务时长足够长（例如超过 50 毫秒），那么用户很可能会注意到延迟，并认为页面缓慢或卡顿。

某个给定长任务的阻塞时间是该任务持续时间超过 50 毫秒的部分。一个页面的总阻塞时间是在 FCP 和 TTI 之间发生的每个长任务的阻塞时间总和。

例如，请看以下这张页面加载期间浏览器主线程的图表：

![主线程上的任务时间轴](https://web-dev.imgix.net/image/admin/clHG8Yv239lXsGWD6Iu6.svg)

上方的时间轴上有五个任务，其中三个是长任务，因为这些任务的持续时间超过 50 毫秒。下图显示了各个长任务的阻塞时间：

![显示阻塞时间的主线程任务时间轴](https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/xKxwKagiz8RliuOI2Xtc.svg)

因此，虽然在主线程上运行任务的总时间为 560 毫秒，但其中只有 345 毫秒被视为阻塞时间。

|            | 任务持续时间 | 任务阻塞时间 |
| ---------- | :----------: | :----------: |
| 任务一     |   250 毫秒   |   200 毫秒   |
| 任务二     |   90 毫秒    |   40 毫秒    |
| 任务三     |   35 毫秒    |    0 毫秒    |
| 任务四     |   30 毫秒    |    0 毫秒    |
| 任务五     |   155 毫秒   |   105 毫秒   |
| 总阻塞时间 |              |   345 毫秒   |

#### TBT 与 TTI 有什么关系

TBT 是 TTI 的一个出色的配套指标，因为 TBT 有助于量化在页面交互性变为可靠前，不可交互程度的严重性。

TTI 会在主线程至少有五秒钟没有长任务时，认为页面具备"可靠交互性"。也就是说，
分布在 10 秒钟里的三个 51 毫秒长的任务与单个 10 秒长的任务对 TTI 的影响是相同的，但对于试图与页面进行交互的用户来说，这两种情况给人的感觉是截然不同的。

在第一种情况下，三个 51 毫秒的任务的 TBT 为 3 毫秒。而单个 10 秒长的任务的 TBT 为 9950 毫秒。第二种情况下较大的 TBT 值对较差的体验进行了量化。

#### 如何改进 TBT

[常见解决方案:](https://web.dev/i18n/zh/tbt/)

- 减少第三方代码的影响
- 减少 JavaScript 执行时间
- 最小化主线程工作
- 保持较低的请求数和较小的传输大小

### Largest Contentful Paint 最大内容绘制(LCP)

最大内容绘制 (LCP) 是测量感知加载速度的一个以用户为中心的重要指标，因为该项指标会在页面的主要内容基本加载完成时，
在页面加载时间轴中标记出相应的点，迅捷的 LCP 有助于让用户确信页面是有效的。

长久以来，对于网页开发者来说，测量网页主要内容的加载速度和内容对用户的显示速度一直是一个挑战。

诸如 load（加载）或 DOMContentLoaded（DOM 内容加载完毕）这样的旧有指标并不是很好，因为这些指标不一定与用户在屏幕上看到的内容相对应。
而像 First Contentful Paint 首次内容绘制 (FCP)这类以用户为中心的较新性能指标只会捕获加载体验最开始的部分。
如果某个页面显示的是一段启动画面或加载指示，那么这些时刻与用户的关联性并不大。

我们以往推荐过一些性能指标，例如 First Meaningful Paint 首次有效绘制 (FMP)和 Speed Index 速度指数 (SI) （两个指标都包含在灯塔工具中），
这些指标有助于捕获到更多初始绘制后的加载体验，但这些指标十分复杂、难以解释，而且常常出错，也就意味着这些指标仍然无法识别出页面主要内容加载完毕的时间点。

有时候简胜于繁。根据 W3C Web 性能工作组的讨论以及 Google 进行的研究，我们发现更准确地测量页面主要内容加载完毕的时间点的方法是查看最大元素完成渲染的时间点。

#### 什么是 LCP

最大内容绘制 (LCP) 指标会根据页面首次开始加载的时间点来报告可视区域内可见的最大图像或文本块完成渲染的相对时间。

![良好的 LCP 值为 2.5 秒，较差的值大于 4.0 秒，两者之间的任何东西都需要改进](https://web-dev.imgix.net/image/tcFciHGuF3MxnTr1y5ue01OGLBn2/elqsdYqQEefWJbUM2qMO.svg)

#### 如何改进 LCP

LCP 主要受四个因素影响：

- 缓慢的服务器响应速度
- JavaScript 和 CSS 渲染阻塞
- 资源加载时间
- 客户端渲染

[常见解决方案:](https://web.dev/i18n/zh/lcp/)

- 使用 PRPL 模式做到即时加载
- 优化关键渲染路径
- 优化您的 CSS
- 优化您的图像
- 优化网页字体
- 优化您的 JavaScript（针对客户端渲染的网站）

### Cumulative Layout Shift 累积布局偏移 (CLS)

重要词汇: 累积布局偏移 (CLS) 是测量视觉稳定性的一个以用户为中心的重要指标，因为该项指标有助于量化用户经历意外布局偏移的频率，较低的 CLS 有助于确保一个页面是令人愉悦的。

您是否曾经历过在网上阅读一篇文章，结果页面上的某些内容突然发生改变？文本在毫无预警的情况下移位，导致您找不到先前阅读的位置。
或者更糟糕的情况：您正要点击一个链接或一个按钮，但在您手指落下的瞬间，诶？链接移位了，结果您点到了别的东西！

大多数情况下，这些体验只是令人恼火，但在某些情况下，却可能带来真正的破坏。

![截屏视频说明了布局不稳定性会对用户产生怎样的负面影响。](https://s4.ax1x.com/2022/01/06/TzmqMV.gif)

页面内容的意外移动通常是由于异步加载资源，或者动态添加 DOM 元素到页面现有内容的上方。
罪魁祸首可能是未知尺寸的图像或视频、实际渲染后比后备字体更大或更小的字体，或者是动态调整自身大小的第三方广告或小组件。

让这个问题变得更加棘手的是，网站在开发环境中的运作方式通常与用户在网站上的实际体验大不相同。
个性化或第三方内容在开发环境中的表现通常与其在实际情况中的表现不同，测试图像通常已经在开发者的浏览器缓存中了，并且本地调用 API 的速度一般非常快，几乎察觉不到延迟。

累积布局偏移 (CLS) 指标通过测量真实用户体验中发生偏移的频率来帮助您解决这一问题。

#### 什么是 CLS

CLS 测量整个页面生命周期内发生的所有意外布局偏移中最大一连串的布局偏移分数。

每当一个可见元素的位置从一个已渲染帧变更到下一个已渲染帧时，就发生了布局偏移 。（有关单次布局偏移分数计算方式的详细信息，请参阅下文。）

一连串的布局偏移，也叫会话窗口，是指一个或多个快速连续发生的单次布局偏移，每次偏移相隔的时间少于 1 秒，且整个窗口的最大持续时长为 5 秒。

最大的一连串是指窗口内所有布局偏移累计分数最大的会话窗口。

![会话窗口示例。蓝色竖条代表每个单次布局偏移的分数。](https://s4.ax1x.com/2022/01/06/TznXlt.gif)

#### 如何改进 CLS

[常见解决方案:](https://web.dev/i18n/zh/cls/)

- **始终在您的图像和视频元素上包含尺寸属性，或者通过使用 CSS 长宽比容器之类的方式预留所需的空间。**这种方法可以确保浏览器能够在加载图像期间在文档中分配正确的空间大小。请注意，您还可以使用 unsized-media 功能策略在支持功能策略的浏览器中强制执行此行为。
- **除非是对用户交互做出响应，否则切勿在现有内容的上方插入内容。**这样能够确保发生的任何布局偏移都在预期之内。
- **首选转换动画，而不是触发布局偏移的属性动画。**动画过渡的目标是提供状态与状态之间的上下文连续性。

## 参考资料

- [web.dev](https://web.dev/)
- [Lighthouse 测试内幕](https://zhuanlan.zhihu.com/p/91365316)
- [LightHouse 是什么？](https://blog.csdn.net/terrychinaz/article/details/113870644)
